---
title: "case-study"
author: "Maxwell C. Cook"
date: "5/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## Load libraries
libs <- c("tidyverse", "sf", "raster", "scales", "lubridate")
invisible(lapply(libs, library, character.only = TRUE))
```

## Case study figure

Load the data.

```{r include=F}
## Environments / Data
setwd("C:/Users/mccoo/OneDrive/mcook/")

# Latest ICS-209-PLUS raw table
incidents <- read_csv(
   "ics209-plus-fired/data/tabular/raw/wf-incidents/ics-209-plus-2.0-pre-release-v2/ics209-plus-wf_incidents_1999to2020.csv") %>%
   rename(GID = '...1') %>%
   mutate(INCIDENT_NAME = toupper(INCIDENT_NAME),
          INCIDENT_ID = toupper(INCIDENT_ID))

# Sitreps
sitreps <- read_csv(
   "ics209-plus-fired/data/tabular/raw/wf-incidents/ics-209-plus-2.0-pre-release-v2/ics209-plus-wf_sitreps_1999to2020.csv") %>%
   rename(GID = '...1') %>%
   mutate(INCIDENT_NAME = toupper(INCIDENT_NAME),
          INCIDENT_ID = toupper(INCIDENT_ID))

# Load the spatial version (all points)- filter to Alaska
dir <- "ics209-plus-fired/data/spatial/raw/wf-incidents/"
spatial.ak <- 
   st_read(paste(dir,"pre-release_v2/ics209-plus-wf_incidents_spatial_1999to2020.gpkg",sep="")) %>%
   filter(POO_STATE=="AK")
## Load the spatial points (CONUS)
spatial.conus <- 
   st_read(paste(dir, "pre-release_v2/ics209-plus-wf_incidents_spatial_conus_1999to2020.gpkg", sep=""))
rm(dir)

# Define the 'burndate' raster
## Grab the correct burndate raster
burn_year = 2017
burndate <- paste(getwd(), "fast-fires/data/burndate", burn_year, sep="/")
# Find ranges and set up plot
modis.dates <- raster::raster(
 file.path(paste(burndate, '/annual_burndate_y', burn_year, '.tif', sep=""))
)

# MTBS perimeter
mtbs <- st_read("data/mtbs/mtbs_perims_1984_2020/mtbs_perims_1984_2020_nad83.gpkg") %>%
   filter(Incid_Name == "CHETCO BAR") %>%
   st_transform(crs(modis.dates))

# load state boundaries
states <- 
   st_read("data/boundaries/political/TIGER/tl19_us_states_conus.gpkg")

```

Filter and crop the data to grab the case study fire (2017 Chetco Bar Fire, OR).

```{r}

# Now crop the raster extent
modis.dates <- modis.dates %>%
   raster::crop(mtbs) %>%
   raster::mask(mtbs)

# Grab the range of burn days
range <- range(modis.dates[],na.rm=TRUE)
start <- as.numeric(range[1])
breaks <- abs(range[1]-range[2])

# Update raster values to get "days since ignition"
modis.dates <- modis.dates - start
# modis.dates[modis.dates>49] <- NA
range <- range(modis.dates[],na.rm=TRUE)

# Extract as DF
modis.dates.df <- as.data.frame(modis.dates, xy = TRUE)
```

Create the burn date plot.

```{r}

# Create the POO
poo <- spatial.conus %>%
   filter(INCIDENT_NAME == "CHETCO BAR" & START_YEAR == 2017)

# Plot
map <- ggplot() +
   geom_raster(data = modis.dates.df, aes(x = x, y = y, fill=annual_burndate_y2017)) +
   scale_fill_fermenter(n.breaks=9, palette="Reds", na.value="white") +
   geom_sf(data=mtbs, fill="transparent", size=0.35) +
   geom_sf(data=poo, shape=18, size=3, fill="black", color="black") +
   labs(title="(a) Chetco Bar Fire MTBS Perimeter and FIRED Daily Progression",
        fill="Days Since Ignition") +
   theme_void() +
   theme(legend.position="bottom",
         plot.title = element_text(hjust = 0.5)) +
   guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5,
                                 barwidth = 12, barheight = 0.3,
                                 ticks=TRUE, draw.llim=FALSE)) +
   ggsn::scalebar(mtbs, dist = 5, st.dist = 0.03, st.size=2, height=-0.01, 
                  dist_unit="km", model = 'WGS84', transform=TRUE,
                  border.size = 0.5, location = "bottomleft") +
   theme(plot.title = element_text(size = 7, hjust=-0.1, vjust=-0.3),
         legend.title = element_text(size = 7),
         legend.text = element_text(size=7),
         plot.margin = margin(0.6,0.6,0.6,0.6, "cm")) +
   coord_sf()

map

ggsave(map, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                         "ICS209-PLUS_version2.0_CaseStudy_ChetcoBar.png", sep=""),
       width=3, height=3.5, dpi = 500) # adjust dpi accordingly

```

Now the sitrep plots.

```{r fig.height=7.5, fig.width=6}
# Create a Day/Month field
sits <- sits %>%
   mutate(REPORT_TO_DATE = as.Date(REPORT_TO_DATE))

# Check a sitrep plot
p1 <- ggplot() +
 geom_line(data=sits, aes(x=REPORT_TO_DATE, y=WF_FSR), size = 0.25, color="gray20") +
 geom_point(data=sits, aes(x=REPORT_TO_DATE, y=WF_FSR), 
            shape=19, size = 0.3) +
 scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
 scale_x_date(date_labels = "%b %d", date_breaks = "20 days", date_minor_breaks = "5 days") + 
 labs(y="Acres/Day", x="",
      title="(b) Simple Fire Spread Rate (acres/day)") +
 theme_classic() +
 theme(plot.title = element_text(size=6, vjust=0.2, hjust=0.2),
       axis.title = element_text(size = 6),
       axis.text.y = element_text(size=5),
       axis.text.x = element_text(size=5,angle=35))

p2 <- ggplot() +
 geom_line(data=sits, aes(x=REPORT_TO_DATE, y=ACRES), size = 0.25, color="gray20") +
 geom_point(data=sits, aes(x=REPORT_TO_DATE, y=ACRES), 
            shape=19, size = 0.3) +
 scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
 scale_x_date(date_labels = "%b %d", date_breaks = "20 days", date_minor_breaks = "5 days") + 
 labs(y="Acres", x="",
      title="(c) Burned Area (acres)") +
 theme_classic() +
 theme(plot.title = element_text(size=6, vjust=0.2, hjust=0.2),
       axis.title = element_text(size = 6),
       axis.text.y = element_text(size=5),
       axis.text.x = element_text(size=5,angle=35))

p3 <- ggplot() +
 geom_line(data=sits, aes(x=REPORT_TO_DATE, y=STR_THREATENED), size = 0.25, color="gray40") +
 geom_point(data=sits, aes(x=REPORT_TO_DATE, y=STR_THREATENED), 
            shape=19, size = 0.3) +
 scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
 scale_x_date(date_labels = "%b %d", date_breaks = "20 days", date_minor_breaks = "5 days") +
 labs(y="# Structures", x="",
      title="(d) Threatened Structures") +
 theme_classic() +
 theme(plot.title = element_text(size=6, vjust=0.2, hjust=0.2),
       axis.title = element_text(size = 6),
       axis.text.y = element_text(size=5),
       axis.text.x = element_text(size=5,angle=35))

p4 <- ggplot() +
 geom_line(data=sits, aes(x=REPORT_TO_DATE, y=EST_IM_COST_TO_DATE), size = 0.25, color="gray40") +
 geom_point(data=sits, aes(x=REPORT_TO_DATE, y=EST_IM_COST_TO_DATE), 
            shape=19, size = 0.3) +
 scale_y_continuous(labels = scales::label_number(suffix = " M", scale = 1e-6)) +
 scale_x_date(date_labels = "%b %d", date_breaks = "20 days", date_minor_breaks = "5 days") +
 labs(y="Cost ($)", x="",
      title="(e) Estimated IM Costs ($)") +
 theme_classic() +
 theme(plot.title = element_text(size=6, vjust=0.2, hjust=0.2),
       axis.title = element_text(size = 6),
       axis.text.y = element_text(size=5),
       axis.text.x = element_text(size=5,angle=35))

p5 <- ggplot() +
 geom_line(data=sits, aes(x=REPORT_TO_DATE, y=STR_DESTROYED), size = 0.25, color="gray40") +
 geom_point(data=sits, aes(x=REPORT_TO_DATE, y=STR_DESTROYED),
            shape=19, size = 0.3) +
 scale_x_date(date_labels = "%b %d", date_breaks = "20 days", date_minor_breaks = "5 days") +
 # scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
 labs(y="# Structures", x="",
      title="(f) Destroyed Structures") +
 theme_classic() +
 theme(plot.title = element_text(size=6, vjust=0.2, hjust=0.2),
       axis.title = element_text(size = 6),
       axis.text.y = element_text(size=5),
       axis.text.x = element_text(size=5,angle=35))

p6 <- ggplot() +
 geom_line(data=sits, aes(x=REPORT_TO_DATE, y=TOTAL_PERSONNEL), size = 0.25, color="gray40") +
 geom_point(data=sits, aes(x=REPORT_TO_DATE, y=TOTAL_PERSONNEL),
            shape=19, size = 0.3) +
 scale_x_date(date_labels = "%b %d", date_breaks = "20 days", date_minor_breaks = "5 days") +
 # scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
 labs(y="# Personnel", x="",
      title="(g) Total Assigned Personnel") +
 theme_classic() +
 theme(plot.title = element_text(size=6, vjust=0.2, hjust=0.2),
       axis.title = element_text(size = 6),
       axis.text.y = element_text(size=5),
       axis.text.x = element_text(size=5,angle=35))

p7 <- ggplot() +
 geom_line(data=sits, aes(x=REPORT_TO_DATE, y=RPT_EVACUATIONS), size = 0.25, color="gray40") +
 geom_point(data=sits, aes(x=REPORT_TO_DATE, y=RPT_EVACUATIONS),
            shape=19, size = 0.3) +
 scale_x_date(date_labels = "%b %d", date_breaks = "20 days", date_minor_breaks = "5 days") +
 # scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
 labs(y="# Evacuations", x="Report Date",
      title="(h) Evacuations Ordered") +
 theme_classic() +
 theme(plot.title = element_text(size=6, vjust=0.2, hjust=0.2),
       axis.title = element_text(size = 6),
       axis.text.y = element_text(size=5),
       axis.text.x = element_text(size=5,angle=35))

p8 <- ggplot() +
 geom_line(data=sits, aes(x=REPORT_TO_DATE, y=TOTAL_AERIAL), size = 0.25, color="gray40") +
 geom_point(data=sits, aes(x=REPORT_TO_DATE, y=TOTAL_AERIAL),
            shape=19, size = 0.3) +
 scale_x_date(date_labels = "%b %d", date_breaks = "20 days", date_minor_breaks = "5 days") +
 # scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
 labs(y="# Aerial", x="Report Date",
      title="(i) Total Aerial Resources") +
 theme_classic() +
 theme(plot.title = element_text(size=6, vjust=0.2, hjust=0.2),
       axis.title = element_text(size = 6),
       axis.text.y = element_text(size=5),
       axis.text.x = element_text(size=5,angle=35))

panel <- ggpubr::ggarrange(p1,p2,p3,p4,p5,p6,p7,p8, ncol=2,nrow=4, vjust=-0.3, align = "hv") +
   theme(plot.margin = margin(0.4,0.4,0.4,0.4, "cm"))

panel

ggsave(panel, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                         "ICS209-PLUS_version2.0_CaseStudy_ChetcoBar_SitReps.png", sep=""),
       width=6, height=7.5, dpi = 700) # adjust dpi accordingly
```

Arrange the panel plot with the map(s).

```{r fig.width=8.5}

comb <- ggpubr::ggarrange(
   map, ggpubr::ggarrange(p1,p2,p3,p4,p5,p6,p7,p8, ncol=2,nrow=4, align = "hv")) +
   theme(plot.margin = margin(0.6,0.6,0.6,0.6, "cm"))

comb 

ggsave(comb, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                         "ICS209-PLUS_version2.0_CaseStudy_ChetcoBar_SitReps_wMap.png", sep=""),
       width=8, height=5.5, dpi = 700, bg="white") # adjust dpi accordingly

```

## Figure 1. Fire distribution from ICS-SPATIAL.

```{r warning=F}
setwd("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/")

ics_counties <- read_csv("data/tabular/mod/ics-spatial/ics_spatial_counties_5.9.22.csv")

counties <- tigris::counties(state = NULL, cb = TRUE, year = 2020, class = "sf")

# Summarize county data
counties.sum <- ics_counties %>%
  filter(!is.na(STATEFP)) %>%
  group_by(GEOID) %>%
  summarise(FIRE_COUNT = n(),
            STR_DESTROYED_TOTAL = sum(STR_DESTROYED_TOTAL, na.rm = TRUE),
            FOD_FINAL_ACRES = sum(FOD_FINAL_ACRES, na.rm = TRUE),
            STR_THREATENED = sum(STR_THREATENED_MAX, na.rm=TRUE),
            TOTAL_PERSONNEL_SUM = sum(TOTAL_PERSONNEL_SUM, na.rm = TRUE),
            WF_MAX_FSR = max(WF_MAX_FSR, na.rm = TRUE),
            WF_MEAN_FSR = mean(WF_MAX_FSR, na.rm=TRUE),
            PEAK_EVACUATIONS = sum(PEAK_EVACUATIONS, na.rm = TRUE),
            PROJECTED_COSTS = sum(PROJECTED_FINAL_IM_COST, na.rm=TRUE))
  
# Create spatial sf version of summarized ICS data
counties.sf <- inner_join(counties%>%as_tibble(), counties.sum, by = "GEOID") %>%
   st_as_sf() %>%
   st_transform(st_crs(5070))

```

Map fire count. CONUS.

```{r fig.width=5.75, fig.height = 4.25}

# Grab CONUS counties
counties.sf.conus <- counties.sf %>% filter(!STUSPS %in% c("AK", "PR", "HI"))
counties.conus <- 
   st_read("C:/Users/mccoo/OneDrive/mcook/data/boundaries/political/TIGER/tl19_us_counties_conus.gpkg") %>%
   st_transform(st_crs(5070))

# Plot log fire counts
county.map.conus <- ggplot() +
   geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
   geom_sf(data = counties.sf.conus, aes(fill = FIRE_COUNT),
           color = "gray89", lwd = 0.2) +
   labs(title="(a) log(Fire Counts) by County (Continental United States)") +
   theme_void() + 
   scico::scale_fill_scico(
      palette = "lajolla", begin = 0, na.value = "grey",
      name = "log(Fire Count)", trans = "log10") +
   guides(fill = guide_colourbar(direction = "horizontal", barwidth = 6, barheight = 0.5, 
                                 ticks=F, title.position = "top")) +
   theme(legend.title = element_text(angle = 0, size=8),
         legend.text = element_text(size=7),
         legend.position=c(0.2, 0.1),
         plot.title = element_text(size=10, hjust=0.2))

county.map.conus

ggsave(county.map.conus, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                                      "ICS209-PLUS_version2.0_FireCounts_CONUS.png", sep=""),
       width=6.5, height=4.25, dpi = 700, bg="white") # adjust dpi accordingly
```

Alaska fire count map.

```{r fig.width = 4, fig.height = 3}

# 'ESRI:102006' # Alaska equal area projection

counties.sf.ak <- counties.sf %>% filter(STUSPS == "AK") %>%
   st_transform(st_crs('ESRI:102006'))
counties.ak <- counties %>% filter(STUSPS == "AK") %>%
   st_as_sf() %>%
   st_transform(st_crs('ESRI:102006'))

# Plot log fire counts
county.map.ak <- ggplot() +
   geom_sf(data = counties.ak, fill = "grey", color = "gray89", lwd = 0.2) +
   geom_sf(data = counties.sf.ak, aes(fill = FIRE_COUNT),
           color = "gray89", lwd = 0.2) +
   labs(title="(b) log(Fire Counts) by County (Alaska)") +
   theme_void() + 
   theme(legend.title=element_text(size=8), 
         legend.text=element_text(size=7),
         legend.position = "bottom",
         plot.title = element_text(size=10, hjust=0.25)) +
   scico::scale_fill_scico(
      palette = "lajolla", begin = 0, na.value = "grey",
      name = "log(Fire Count)", trans = "log10") +
   guides(fill="none")

county.map.ak

ggsave(county.map.ak, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                                   "ICS209-PLUS_version2.0_FireCounts_AK.png", sep=""),
       width=3.25, height=2.75, dpi = 300, bg="white") # adjust dpi accordingly
```

Histogram.

```{r fig.height=2.25, fig.width=3.25}

df <- incidents %>%
   mutate(
      HIST = if_else(START_YEAR <= 2001, "Hist1", "NA"),
      HIST = if_else(START_YEAR >= 2002 & START_YEAR <= 2013, "Hist2", HIST),
      HIST = if_else(START_YEAR >= 2014, "Current", HIST)
   ) %>%
   group_by(START_YEAR, HIST) %>%
   summarize(
      counts = n()) %>%
   ungroup() %>%
  # Now manually update the field for overlap
  mutate(counts = if_else(HIST=="Hist1"&START_YEAR==2001, 1032, as.double(counts)),
         counts = if_else(HIST=="Hist2"&START_YEAR==2002, 1008, as.double(counts))) %>%
  add_row(HIST="Hist1", START_YEAR=2002, counts=147) %>%
  add_row(HIST="Hist2", START_YEAR=2001, counts=152)

histo <- ggplot(data=df, aes(x=START_YEAR, y=counts, fill=as.factor(HIST))) +
   geom_bar(stat="identity", position=position_stack(reverse=TRUE)) +
   scale_fill_manual(breaks=c("Hist1","Hist2","Current"),
                     values=c("light blue", "dark red", "orange")) +
   labs(y="",x="",title="(c) Number of wildfire incidents by year",
        fill="") +
   theme_minimal() +
   theme(
      plot.title = element_text(size=10, hjust=0.1),
      axis.title = element_text(size=8),
      axis.text.x = element_text(size=7,angle=35),
      axis.text.y = element_text(size=7),
      legend.position = c(0.12, 0.85),
      legend.text = element_text(size=6),
      legend.key.size = unit(0.8,"line")
   )

histo

ggsave(histo, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                                      "ICS209-PLUS_version2.0_FireCounts_Histogram.png", sep=""),
       width=3, height=2, dpi = 300, bg="white") # adjust dpi accordingly

rm(df)
```

Combine.

```{r fig.height = 5.25, fig.width = 6.5}

comb <- ggpubr::ggarrange(
   county.map.conus, ggpubr::ggarrange(county.map.ak, histo, ncol=2, align="hv"), nrow=2
)

comb

ggsave(comb, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_FireCounts_Panel.png", sep=""),
       width=6.5, height=5.25, dpi = 500, bg="white") # adjust dpi accordingly

```

Key variables 6-Panel plot.

```{r}
# Total acres
acres <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = FOD_FINAL_ACRES),
          color = "gray89", lwd = 0.2) +
  labs(title="(a) Burned area (acres)") +
  theme_void() + 
  scico::scale_fill_scico(
    palette = "lajolla", begin = 0, na.value = "grey",
    name = "log(Burned Acres)", trans="log10",
    labels = label_number(suffix = " M", scale = 1e-6)) +
  theme(legend.title=element_text(size=7, hjust=0.2), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7))  

ggsave(acres, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_KeyVars_Acres_sc.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly


# Max spread rate
fsr <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(WF_MAX_FSR)),
          color = "gray89", lwd = 0.2) +
  labs(title = "(b) Max fire spread rate (acres/day)") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Maximum fire spread rate (log scale)") +
  theme(legend.title=element_text(size=7, hjust=0.2), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(fsr, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_KeyVars_FSR.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly

# Max spread rate
fsr2 <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(WF_MEAN_FSR)),
          color = "gray89", lwd = 0.2) +
  labs(title = "(b) Average max fire spread rate (acres/day)") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Average max fire spread rate (log scale)") +
  theme(legend.title=element_text(size=7, hjust=0.2), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(fsr2, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_KeyVars_FSRmean.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly

# Count of fires
threat <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(STR_THREATENED)),
          color = "gray89", lwd = 0.2) +
  labs(title="(e) Total structures threatened") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Structures threatened (log scale)") +
  theme(legend.title=element_text(size=7, hjust=0.2), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(threat, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_KeyVars_Threat.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly


# Structures destroyed (log)
struct <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(STR_DESTROYED_TOTAL)),
          color = "gray89", lwd = 0.2) +
  labs(title="(f) Total structures destroyed") +
  theme_void() +
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Total structures destroyed (log scale)") +
  theme(legend.title=element_text(size=7, hjust=0.2), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(struct, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_KeyVars_Destr.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly

# Personnel costs
personnel <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(TOTAL_PERSONNEL_SUM)),
          color = "gray89", lwd = 0.2) +
  labs(title="(c) Total assigned personnel") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Assigned personnel (log scale)") +
  theme(legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(personnel, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                               "ICS209-PLUS_version2.0_KeyVars_Personnel.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly

# Projected IM costs
cost <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(PROJECTED_COSTS)),
          color = "gray89", lwd = 0.2) +
  labs(title="(c) Projected IM costs ($)") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Projected costs (log scale)") +
  theme(legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(cost, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                               "ICS209-PLUS_version2.0_KeyVars_ProjCost.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly


# Max evacuations
evacuation <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(PEAK_EVACUATIONS)),
          color = "gray89", lwd = 0.2) +
  labs(title="(d) Total evacuations (2014-2020)") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Total evacuations (log scale)") +
  theme(legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(evacuation, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                                "ICS209-PLUS_version2.0_KeyVars_Evac.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly

```

Copy.
```{r}
# Total acres
acres <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(FOD_FINAL_ACRES)),
          color = "gray89", lwd = 0.2) +
  labs(title="(a) Burned area (acres)") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Total burned acres (log scale)") +
  theme(legend.title=element_text(size=7, hjust=0.2), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7))  

ggsave(acres, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_KeyVars_Acres.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly


# Max spread rate
fsr <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(WF_MAX_FSR)),
          color = "gray89", lwd = 0.2) +
  labs(title = "(b) Max fire spread rate (acres/day)") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Maximum fire spread rate (log scale)") +
  theme(legend.title=element_text(size=7, hjust=0.2), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(fsr, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_KeyVars_FSR.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly

# Max spread rate
fsr2 <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(WF_MEAN_FSR)),
          color = "gray89", lwd = 0.2) +
  labs(title = "(b) Average max fire spread rate (acres/day)") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Average max fire spread rate (log scale)") +
  theme(legend.title=element_text(size=7, hjust=0.2), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(fsr2, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_KeyVars_FSRmean.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly

# Count of fires
threat <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(STR_THREATENED)),
          color = "gray89", lwd = 0.2) +
  labs(title="(e) Total structures threatened") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Structures threatened (log scale)") +
  theme(legend.title=element_text(size=7, hjust=0.2), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(threat, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_KeyVars_Threat.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly


# Structures destroyed (log)
struct <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(STR_DESTROYED_TOTAL)),
          color = "gray89", lwd = 0.2) +
  labs(title="(f) Total structures destroyed") +
  theme_void() +
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Total structures destroyed (log scale)") +
  theme(legend.title=element_text(size=7, hjust=0.2), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(struct, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                           "ICS209-PLUS_version2.0_KeyVars_Destr.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly

# Personnel costs
personnel <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(TOTAL_PERSONNEL_SUM)),
          color = "gray89", lwd = 0.2) +
  labs(title="(c) Total assigned personnel") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Assigned personnel (log scale)") +
  theme(legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(personnel, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                               "ICS209-PLUS_version2.0_KeyVars_Personnel.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly

# Projected IM costs
cost <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(PROJECTED_COSTS)),
          color = "gray89", lwd = 0.2) +
  labs(title="(c) Projected IM costs ($)") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Projected costs (log scale)") +
  theme(legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(cost, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                               "ICS209-PLUS_version2.0_KeyVars_ProjCost.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly


# Max evacuations
evacuation <- ggplot() +
  geom_sf(data = counties.conus, fill = "grey", color = "gray89", lwd = 0.2) +
  geom_sf(data = counties.sf.conus, 
          aes(fill = log(PEAK_EVACUATIONS)),
          color = "gray89", lwd = 0.2) +
  labs(title="(d) Total evacuations (2014-2020)") +
  theme_void() + 
  scico::scale_fill_scico(palette = "lajolla",
                          begin = 0,
                          na.value = "grey",
                          name = "Total evacuations (log scale)") +
  theme(legend.title=element_text(size=7), 
        legend.text=element_text(size=6),
        legend.position=c(0.2, 0.1)) +
  guides(fill = guide_colourbar(direction = "horizontal",
                                label.position = "bottom",
                                title.position="top",
                                barwidth = 6.5, barheight = 0.7)) 

ggsave(evacuation, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                                "ICS209-PLUS_version2.0_KeyVars_Evac.png", sep=""),
       width=5, height=4, dpi = 700, bg="white") # adjust dpi accordingly

```

Arrange.

```{r fig.height=9, fig.width=7}

# Try to arrange with ggarrange
comb <- ggpubr::ggarrange(
  acres, fsr, threat, struct, personnel, evacuation,
  nrow=3, ncol=2, align="hv"
) +
  theme(plot.margin = margin(0.4,0.4,0.4,0.4))

comb

ggsave(
  comb,
  file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
               "ICS209-PLUS_version2.0_KeyVars_6Panel.png", sep=""),
  dpi = 700, bg="white") # adjust dpi accordingly

```



## CONUS summaries map(s).

```{r}

conus <- ggplot() +
  geom_sf(data=states, fill=NA, color="gray20") +
  geom_sf(data=spatial.conus %>% arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=STR_DESTROYED_TOTAL), alpha=0.8) +
  scale_size(range = c(1,6)) +
  scale_color_viridis_c(option="inferno", trans="log10") +
  labs(color = "Destroyed Structures") +
  coord_sf(crs = st_crs(spatial.conus)) +
  theme_void() +
  guides(color = guide_colourbar(
     position="top", barwidth = 0.4, barheight = 6, ticks=F,
     label.position = "right", title.position = "left",
     label.theme = element_text(angle = 0, size = 8)),
     size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(0.85, 0.7))

conus

# ggsave(map1, file = paste("../../figs/Map1-ICS209-PLUS_HomesDestroyed_Size_CONUS.png", sep=""), 
#        width=5, height=5, dpi = 350) # adjust dpi accordingly

```

Hexbin map(s).

```{r}

# create the hex grid
hex <- st_make_grid(
   states, n=c(50,50), what="polygons", square=FALSE, 
   flat_topped=TRUE, crs=st_crs(5070)) %>%
   st_as_sf() %>%
   mutate(HEXID = floor(as.numeric(rownames(.))))

# Join to incident reports
hex.join <- st_join(spatial.conus, hex%>%st_transform(st_crs(5070)), join=st_within)

# Create the summary table
sums <- hex.join %>% group_by(HEXID) %>%
   st_drop_geometry() %>%
   summarize(counts = n()) %>%
   ungroup()

# Join back to hex grid
hex_ <- inner_join(hex%>%as_tibble(), sums, by="HEXID") %>% st_as_sf()

# plot it
hexmap.conus <- ggplot()+
   geom_sf(data=states, color="transparent", fill="gray90", size=0.5)+
   geom_sf(data=hex_, aes(fill=counts), color="transparent")+
   scale_fill_viridis_c(option="inferno", trans="log10", alpha=0.9)+
   geom_sf(data=states, color="gray30", fill="transparent", size=0.5)+
   theme_void() +
   guides(
          fill = guide_colourbar(
             position="top", barwidth = 0.4, barheight = 6, ticks=F,
             label.position = "right", title.position = "left",
             label.theme = element_text(angle = 0, size = 8))) +
   labs(fill="log(Fire Counts)") +
   theme(legend.title = element_text(angle = 90, size=10),
         legend.position=c(0.9, 0.3))

hexmap.conus

# Save
ggsave(hexmap.conus, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209-plus-fired/figs/",
                                  "ICS209-PLUS_version2.0_FireCounts_Hex_CONUS.png", sep=""),
       width=5, height=3.5, dpi = 700, bg="white") # adjust dpi accordingly
```

Alaska.

```{r}

ak <- states %>% filter(STUSPS=="AK")

# create the hex grid
hex <- st_make_grid(
   ak, n=c(50,50), what="polygons", square=FALSE, 
   flat_topped=TRUE, crs=st_crs(5070)) %>%
   st_as_sf() %>%
   mutate(HEXID = floor(as.numeric(rownames(.))))

# Join to incident reports
hex.join <- st_join(spatial.ak, hex%>%st_transform(st_crs(5070)), join=st_within)

# Create the summary table
sums <- hex.join %>% group_by(HEXID) %>%
   st_drop_geometry() %>%
   summarize(counts = n()) %>%
   ungroup()

# Join back to hex grid
hex_ <- inner_join(hex%>%as_tibble(), sums, by="HEXID") %>% st_as_sf()

# plot it
ggplot()+
   geom_sf(data=hex_, aes(fill=counts), color="transparent")+
   scale_fill_viridis_c(option="inferno", trans="log10", alpha=0.9)+
   geom_sf(data=states, color="gray50", fill="transparent", size=0.5)+
   theme_void() +
   guides(fill="none")

```

Histogram.

```{r fig.height=2, fig.width=3.5}

incidents %>% group_by(START_YEAR) %>%
   summarize(
      counts = n()) %>%
   ggplot(aes(x=START_YEAR, y=counts)) +
   geom_bar(stat="identity")

```

