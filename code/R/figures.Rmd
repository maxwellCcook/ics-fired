---
title: "figures"
author: "Maxwell C. Cook"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("setup.R")
```

Bring in the spatial ics-209-plus, ICS+FIRED.

```{r include=F, warning=F}
ics.points <- st_read("../../data/spatial/raw/wf-incidents/ics-209-plus-2.0/ics209plus-wf_incidents_spatial_us_1999to2020.gpkg")
ics.fired <- st_read("../../data/spatial/mod/ics-fired/ics209plus_fired_combined.gpkg")
ics.counties <- read_csv("../../data/tabular/mod/ics-spatial/ics_spatial_counties_for_pub.csv", show_col_types=F)
```

Export a cleaned version of the ICS+FIRED.

```{r}
getwd()
# Load ignition point table
ig.points <- read_csv("../../data/tabular/mod/wf-incidents/ics209plus_fired_ig_poo_coords.csv")

ics.fired_ <- ics.fired %>% 
 st_set_geometry(NULL) %>%
 as_tibble() %>%
 inner_join(ig.points, by="FIRED_ID") %>%
 rename(FIRED_ACRES = tot_ar_ac) %>%
 mutate(FIRED_SIMPLE_FSR = fsr_km2_dy*247.105,
        FIRED_MAX_GROWTH = mx_grw_km2*247.105) %>%
 dplyr::select(INCIDENT_ID, FIRED_ID, FIRED_ACRES, FIRED_SIMPLE_FSR, 
               FIRED_MAX_GROWTH, FIRED_IG_LON, FIRED_IG_LAT)

# Write it out
write_csv(ics.fired_, "../../data/tabular/mod/wf-incidents/ics209plus_fired_attributes_clean.csv")
 
```

## Summary Figures by Regions

State Administrative Units (using shifted Alaska from albersusa package).

```{r, messages=F, warning=F, fig.height=4, fig.width=5.5}

# Read in the formatted CONUS+AK file
library(albersusa,quietly=TRUE)

# states <- st_read("../../../data/boundaries/political/TIGER/tl19_us_states_w_ak_lambert.gpkg")
states <- usa_sf() %>%
 rename(STUSPS = iso_3166_2) %>%
 st_transform(st_crs(ics.points))
state.summary <- read_csv("../../data/tabular/mod/summaries/conus_state_summary_key_vars.csv")

# join the attributes
state.summary <- left_join(
 states %>% as_tibble(), state.summary, by="STUSPS") %>%
 st_as_sf()

# plot key metrics
map1 <- ggplot() +
  geom_sf(data=state.summary, aes(fill=STR_DESTR_TOTAL), color="gray40") +
  scale_fill_viridis_c(option="magma", trans="log10", na.value = 0) +
  labs(fill="Structures Destroyed") +
  theme_void() + 
  guides(fill = guide_colourbar(direction = "horizontal", barwidth = 6, barheight = 0.5, 
                                ticks=F, title.position = "top"),
         label.theme = element_text(angle = 0, size = 8)) +
  theme(legend.title = element_text(angle = 0, size=8),
         legend.text = element_text(size=7),
         legend.position=c(0.8, 0.1),
         plot.title = element_text(size=10, hjust=0.2))
map1
# Save it
ggsave(map1, file = "../../figures/Westwide-PLUS_HomeLoss_byIncident_1999to2020.png",
       width=5.5, height=4, dpi = 350, bg="white") # adjust dpi accordingly

rm(states, state.summary, map1)
```

Geographic Area Coordination Centers (GACC).

```{r, messages=F, warnings=F, fig.height=4, fig.width=5.5}

gaccs <- st_read("../../../data/boundaries/political/GACC/national_gacc_current.gpkg") %>%
 st_transform(st_crs(ics.points))
gacc.summary <- read_csv("../../data/tabular/mod/summaries/conus_gacc_summary_key_vars.csv")

# join the attributes
gacc.summary <- left_join(
 gaccs %>% as_tibble(), gacc.summary, by="GACCAbbrev") %>%
 st_as_sf() %>%
 st_transform(st_crs(ics.points))

# plot key metrics
ggplot() +
  geom_sf(data=gacc.summary, aes(fill=STR_DESTR_TOTAL), color="gray40") +
  scale_fill_viridis_c(option="magma", trans="log10", na.value = 0) +
  labs(fill="Structures Destroyed") +
  theme_void() + 
  guides(fill = guide_colourbar(direction = "horizontal", barwidth = 6, barheight = 0.5, 
                                ticks=F, title.position = "top"),
         label.theme = element_text(angle = 0, size = 8)) +
  theme(legend.title = element_text(angle = 0, size=8),
         legend.text = element_text(size=7),
         legend.position=c(0.2, 0.1),
         plot.title = element_text(size=10, hjust=0.2))

rm(gaccs, gacc.summary)

```

Ecoregions (Level III).

```{r, messages=F, warnings=F, fig.height=4, fig.width=5.5}

ecol3 <- st_read("../../../data/boundaries/ecological/ecoregion/na_cec_eco_l3.gpkg")
states <- st_read("../../../data/boundaries/political/TIGER/tl19_us_states_w_ak_lambert.gpkg")
eco.summary <- read_csv("../../data/tabular/mod/summaries/conus_ecol3_summary_key_vars.csv")

# join the attributes
eco.summary <- inner_join(
 ecol3 %>% as_tibble(), eco.summary, by="NA_L3CODE") %>%
 st_as_sf() %>%
 st_transform(st_crs(ics.points))

# plot key metrics
ggplot() +
  geom_sf(data=eco.summary, aes(fill=STR_DESTR_TOTAL), color=NA) +
  geom_sf(data=states, fill=NA) +
  scale_fill_viridis_c(option="magma", trans="log10", na.value = 0) +
  labs(fill="Structures Destroyed") +
  theme_void() + 
  guides(fill = guide_colourbar(direction = "horizontal", barwidth = 6, barheight = 0.5, 
                                ticks=F, title.position = "top"),
         label.theme = element_text(angle = 0, size = 8)) +
  theme(legend.title = element_text(angle = 0, size=8),
         legend.text = element_text(size=7),
         legend.position=c(0.2, 0.1),
         plot.title = element_text(size=10, hjust=0.2))

rm(ecol3, eco.summary)

```


## Figure 1. Spatial and temporal distribution of residential structure loss.

Map structures destroyed and burned area.

```{r fig.height=5, fig.width=5}

map1 <- ggplot() +
  geom_sf(data=ics.west.plus%>%filter(STR_DESTROYED_RES_TOTAL==0), color="gray60", size=0.3, alpha=0.9) +
  geom_sf(data=states%>%filter(STUSPS %in% states.sub), fill=NA, color="gray20") +
  geom_sf(data=ics.west.plus%>%filter(STR_DESTROYED_RES_TOTAL>0)%>%arrange(STR_DESTROYED_RES_TOTAL),
          aes(color=STR_DESTROYED_RES_TOTAL, size=FINAL_ACRES), alpha=0.8) +
  scale_size(range = c(1,6)) +
  scale_color_viridis_c(option="inferno", trans="log10") +
  labs(color = "Homes Destroyed") +
  coord_sf(crs = st_crs(ics.conus)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6, ticks=F,
                                 label.position = "right", title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),
         size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(0.85, 0.7))
map1
ggsave(map1, file = paste("../../figs/Map1-ICS209_HomesDestroyed_Area_WestPlus.png", sep=""), 
       width=5, height=5, dpi = 350) # adjust dpi accordingly
rm(map1)
```

Homes destroyed by incident.

```{r fig.width=4, fig.height=2.5, warning=F}
## reorder factors
ics.west.plus$INCIDENT_NAME <- 
  reorder(ics.west.plus$INCIDENT_NAME, ics.west.plus$STR_DESTROYED_RES_TOTAL)
ics.west.plus$INCIDENT_NAME <- 
  factor(ics.west.plus$INCIDENT_NAME, levels=rev(levels(ics.west.plus$INCIDENT_NAME)))
# Grab the top 15
top5 <- ics.west.plus %>% slice_max(STR_DESTROYED_RES_TOTAL, n=5)
# Plot and label
f1 <- ggplot(data=ics.west.plus, aes(x=START_YEAR, y=STR_DESTROYED_RES_TOTAL, 
                                     group=factor(INCIDENT_NAME), 
                                     fill=STR_DESTROYED_RES_TOTAL), color="grey90") +
  geom_bar(stat="identity", position='stack') +
  scale_fill_viridis_c(option="inferno", trans="log10") +
  labs(
    x="", y="Homes Destroyed\n", fill="") +
  # title="Homes destroyed by Western wildfires (1999-2020)\n",
  # caption="Maxwell C. Cook, PhD Student, Department of Geography,
  # University of Colorado, Boulder\nData source: St. Denis et al., 2020 (updated)") +
  # ggrepel::geom_text_repel(data=. %>% filter(INCIDENT_ID %in% top5$INCIDENT_ID),
  #                          aes(label=INCIDENT_NAME), position=position_dodge(0.5), size = 2) +
  theme_minimal() +
  theme(plot.title = element_text(size = 9),
        plot.subtitle = element_text(size=7),
        plot.caption = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        axis.text.y = element_text(size=7),
        axis.text.x = element_text(size=7),
        legend.position="none")
f1
ggsave(f1, file = "../../figs/Westwide-PLUS_HomeLoss_byIncident_1999to2020.png",
       width=4, height=2.5, dpi = 300) # adjust dpi accordingly
rm(top5)
rm(f1)
```

Burned area (option 1).

```{r fig.width=4, fig.height=2.5, warning=F}
## reorder factors
ics.west.plus$INCIDENT_NAME <- 
  reorder(ics.west.plus$INCIDENT_NAME, ics.west.plus$FINAL_ACRES)
ics.west.plus$INCIDENT_NAME <- 
  factor(ics.west.plus$INCIDENT_NAME, levels=rev(levels(ics.west.plus$INCIDENT_NAME)))
## Plot it
f2 <- ggplot(data=ics.west.plus, aes(x=START_YEAR, y=FINAL_ACRES, 
                                     group=factor(INCIDENT_NAME), 
                                     fill=FINAL_ACRES), color="black") +
  geom_bar(stat='identity', position="stack") +
  scale_fill_viridis_c(option="rocket", trans="sqrt") +
  scale_y_continuous(labels = scales::label_number(suffix = " M", scale = 1e-6)) +
  theme_minimal() +
  labs(x="", y="Burned Area (acres)") +
  theme(plot.title = element_text(size = 9),
        plot.subtitle = element_text(size=7),
        plot.caption = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        axis.text.y = element_text(size=7),
        axis.text.x = element_text(size=7),
        legend.position="none")
f2
ggsave(f2, file = "../../figs/Westwide-PLUS_BurnedArea_byIncident_1999to2020.png",
       width=4, height=2.5, dpi = 300) # adjust dpi accordingly
rm(f2)
```

Burned area (Option 2).

```{r fig.width=4, fig.height=2.5, warning=F}
## Plot
f3 <- ics.west.plus %>% group_by(START_YEAR) %>%
  summarize(burned_area = sum(FINAL_ACRES)) %>%
  ungroup() %>%
  ggplot(aes(x=START_YEAR, y=burned_area)) +
  geom_line() +
  geom_point(aes(size=burned_area, fill=burned_area), shape=21, color = "gray20") +
  scale_fill_viridis_c(option="rocket", trans="sqrt") +
  scale_size(1,5) +
  scale_y_continuous(labels = scales::label_number(suffix = " M", scale = 1e-6)) +
  scale_x_continuous(limits=c(1999, 2020)) +
  coord_cartesian(clip = "off") +
  labs(x="\nIgnition Year", y="Burned Area (acres)\n", title="") +
  theme_minimal() +
  theme(plot.title = element_text(size = 9),
        plot.subtitle = element_text(size=7),
        plot.caption = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        axis.text.y = element_text(size=7),
        axis.text.x = element_text(size=7),
        legend.position="none")
f3
ggsave(f3, file = "../../figs/Westwide-PLUS_BurnedArea_1999to2020.png",
       width=4, height=2.5, dpi = 300) # adjust dpi accordingly
rm(f3)
```

Arrange a figure. 

```{r fig.height=5, fig.width=7.5, warning=F}
arr1 <- ggarrange(ggarrange(f1, f3, nrow=2, ncol=1, align="v"), 
                  map1, ncol=2, nrow=1, align="h")
# arr1 <- annotate_figure(
#   arr1, bottom = text_grob("Data Source: St. Denis et al. (2020), updated", 
#                            face="italic", color = "black",
#                            hjust = 1, x = 1, size = 8))
arr1
ggsave(arr1, file = "../../figs/Westwide_HomeLoss_Burned_Area_byIncident_wMap_1999to2020.png",
       width=7.5, height=5, dpi = 300) # adjust dpi accordingly
rm(arr1)
```

## ICS+FIRED Summary Figures

Here we generate a suite of figures to support the ICS+FIRED workflow.

Figure 1. Comparison of annual area burned (total) and captured by ICS+FIRED.

Importantly, we need to first account for some of the possible "double-counting" that occurs due to the complex associations table. We can do this by removing "MEMBER_INCIDENT_ID" that are captured as a complex.

```{r}

# Handle member incidents from complex associations.
# Load the complex associations tables
complex <- read_csv("../../data/tabular/raw/wf-incidents/ics-209-plus-2.0/cpx-assocs-1999-2020.csv")

# Grab a DF of the complex IDs only
df.cpx <- ics.points %>%
 filter(INCIDENT_ID %in% complex$CPLX_INCIDENT_ID)

# Filter out the MEMBER_INCIDENT_ID
df.mem <- ics.points %>%
 filter(!INCIDENT_ID %in% complex$MEMBER_INCIDENT_ID)

# Merge back together
df <- bind_rows(df.mem,df.cpx)

# Test (Central LNU)
dim(df %>% filter(INCIDENT_ID=="2017_7241051_TUBBS"))
dim(df %>% filter(INCIDENT_ID=="2017_7293180_CENTRAL LNU COMPLEX"))

# Tidy up
rm(df.cpx,df.mem)

```

Figure 1A: Results from Linear Model

```{r}

# Create a LM to show the relationship between ICS and FIRED acres
lm.fit <- lm(FINAL_ACRES ~ tot_ar_ac, data=ics.fired)
r2 = round(summary(lm.fit)$r.squared, 2)
summary(lm.fit)
plot(lm.fit)
print("~~~~~~~~~")

# Predict
pred <- predict(lm.fit, interval="confidence")
pred <- cbind(ics.fired,pred)

# Plot
p1 <- ggplot(data=pred, aes(x=tot_ar_ac,y=FINAL_ACRES)) +
 geom_point(size=0.75) +
 geom_ribbon(aes(ymin=lwr,ymax=upr),alpha=0.25)+
 geom_line(aes(y=fit),size=0.8)+
 scale_y_continuous(labels = scales::label_number(suffix=" M", scale=1e-6)) +
 scale_x_continuous(labels = scales::label_number(suffix=" M", scale=1e-6)) +
 labs(title="Predicted Burned Area (ICS+FIRED)",
      subtitle=paste0("R-sq: ",r2),
      x="FIRED Acres",y="ICS209-PLUS Acres") +
 theme_minimal() +
 theme(plot.title = element_text(size = 10),
       plot.subtitle = element_text(size = 8))
p1
rm(r2,lm.fit,pred)

```

Figure 1B. Annual area burned percent complete by ICS+FIRED.

```{r fig.width=7.5, fig.height=4.25}

# Group the western U.S. incidents
grp <- ics.fired %>% 
  group_by(START_YEAR) %>%
  summarize(burned_area = sum(FINAL_ACRES)) %>%
  ungroup()

# Plot the comparison
p2 <- df %>% 
 filter(START_YEAR>2000) %>%
 group_by(START_YEAR) %>%
 summarize(burned_area = sum(FINAL_ACRES)) %>%
 ungroup() %>%
 ggplot(aes(x=START_YEAR, y=burned_area)) +
 geom_line(data=grp, aes(x=START_YEAR, y=burned_area, color="ICS+FIRED"), position="stack",
           linetype = 6, size = 0.8) +
 geom_point(data=grp, aes(x=START_YEAR, y=burned_area), 
            shape=21, size = 1.75, color = "gray20", fill = "gray50") +
 geom_line() +
 geom_point(shape=21, size = 2.5, color = "gray20", fill = "red") +
 scale_y_continuous(labels = scales::label_number(suffix = " M", scale = 1e-6)) +
 scale_x_continuous(limits=c(1999, 2020)) +
 scale_color_manual(name = "", values=c("ICS+FIRED"="gray60")) +
 labs(x="Ignition Year", y="Burned Area (acres)", title="CONUS+AK Burned Area (2001-2020)",
      subtitle="81.4% of Burned Area Captured by ICS+FIRED") +
 theme_minimal() +
 theme(plot.title = element_text(size = 10),
       plot.subtitle = element_text(size = 8),
       legend.position=c(0.2, 0.95))
p2


# Combine the two
p3 <- ggpubr::ggarrange(p1,p2)
p3

# Save it
ggsave(p3, file = "../../figures/ics209plus_ICS-FIRED_burnedArea_compare.png",
       width=7.5, height=3.5, dpi = 350, bg="white") # adjust dpi accordingly

# Tidy
rm(p1,p2,p3,grp)

```

Figure 2. Map of Structures Destroyed Captured in ICS+FIRED

```{r}

map <- ggplot() +
  geom_sf(data=ics.points, color="gray60", size=0.3, alpha=0.9) +
  geom_sf(data=states, fill=NA, color="gray20") +
  geom_sf(data=ics.fired %>% filter(STR_DESTROYED_TOTAL>0) %>% arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.8) +
  scale_size(range = c(1,6)) +
  scale_color_viridis_c(option="inferno", trans="log10") +
  labs(color = "Structures Destroyed") +
  coord_sf(crs = st_crs(ics.points)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6, ticks=F,
                                 label.position = "right", title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),
         size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(0.85, 0.7))

map

ggsave(map1, file = paste("../../figures/ics_plus_fired_HomesDestroyed_conus-ak.png", sep=""),
       width=5, height=5.75, dpi = 350, bg="white") # adjust dpi accordingly

```


Print some summary statistics for CONUS and West+.

```{r}
print("~~~~~~~~CONUS~~~~~~~~")
# Burned area
print(paste("Burned Area (acres): ", format(round(as.numeric(sum(ics.conus$FINAL_ACRES)), 1), 
                                            nsmall=1, big.mark=","), sep=""))
# Homes
print(paste("Homes Destroyed: ", round(sum(ics.conus$STR_DESTROYED_RES_TOTAL), 0), sep=""))
# Cost
print(paste("Projected Suppression Costs: ", 
            format(round(as.numeric(sum(ics.conus$PROJECTED_FINAL_IM_COST, na.rm=T)), 1), 
                   nsmall=1, big.mark=","), sep=""))
## For west+
print("~~~~~~~~West-Wide~~~~~~~~")
west.plus <- c("AZ", "CO", "NV", "WY", "CA", "ID", "WA", "OR", "NM", "MT", "UT", "TX", "OK")
ics.west.plus <- ics.conus %>% filter(STUSPS %in% west.plus)
# Burned area
print(paste("Burned Area (acres): ", format(round(as.numeric(sum(ics.west.plus$FINAL_ACRES)), 1), 
                                            nsmall=1, big.mark=","), sep=""))
# Homes
print(paste("Homes Destroyed: ", round(sum(ics.west.plus$STR_DESTROYED_RES_TOTAL), 0), sep=""))
# Cost
print(paste("Projected Suppression Costs: ", 
            format(round(as.numeric(sum(ics.west$PROJECTED_FINAL_IM_COST, na.rm=T)), 1), 
                   nsmall=1, big.mark=","), sep=""))

## West-wide percentages
print("~~~~~~~~~~~Percentages~~~~~~~~~~~~")
sum(ics.west$FINAL_ACRES, na.rm=T) / sum(ics.conus$FINAL_ACRES, na.rm=T) * 100
sum(ics.west$STR_DESTROYED_RES_TOTAL, na.rm=T) / sum(ics.conus$STR_DESTROYED_RES_TOTAL, na.rm=T) * 100
sum(ics.west$PROJECTED_FINAL_IM_COST, na.rm=T) / sum(ics.conus$PROJECTED_FINAL_IM_COST, na.rm=T) * 100

```

## ICS209-PLUS Figures

Plot burned area reported by the ICS-209-PLUS West-wide and CONUS.

```{r fig.width=5, fig.height=3}

# Group the western U.S. incidents
ics.west.yr <- ics.west %>% 
  group_by(START_YEAR) %>%
  summarize(burned_area = sum(FINAL_ACRES)) %>%
  ungroup()

# Grab the top 5
top5 <- ics.west.yr %>% slice_max(burned_area, n=5)

# Plot
f1 <- ics.conus %>% group_by(START_YEAR) %>%
  summarize(burned_area = sum(FINAL_ACRES)) %>%
  ungroup() %>%
  ggplot(aes(x=START_YEAR, y=burned_area)) +
  geom_line(data=ics.west.yr, aes(x=START_YEAR, y=burned_area, color="Western U.S."), position="stack",
            linetype = 6, size = 0.8) +
  geom_point(data=ics.west.yr, aes(x=START_YEAR, y=burned_area), 
             shape=21, size = 1.75, color = "gray20", fill = "gray50") +
  geom_text(data=. %>% filter(START_YEAR %in% top5$START_YEAR), 
            aes(label=paste(round(burned_area / 1e6, 1), "M")),
            position=position_nudge(x=-1.2,y=-10), size=3) +
  geom_line() +
  geom_point(shape=21, size = 2.5, color = "gray20", fill = "red") +
  scale_y_continuous(labels = scales::label_number(suffix = " M", scale = 1e-6)) +
  scale_x_continuous(limits=c(1999, 2020)) +
  scale_color_manual(name = "", values=c("Western U.S."="gray60")) +
  labs(x="\nIgnition Year", y="Burned Area (acres)\n", title="Conterminous U.S. burned area (1999-2020)\n") +
  theme_minimal() +
  theme(plot.title = element_text(size = 12, hjust=-0.4),
        legend.position=c(0.2, 1.1))

f1

ggsave(f1, file = "../../figs/ICS209-PLUS_BurnedArea_westANDconus.png",
       width=5, height=3, dpi = 300) # adjust dpi accordingly

rm(top5)

```

Plot structures destroyed by incident.

```{r fig.height=3.5, fig.width=6}

# Grab the top 15
top10 <- ics.west %>% slice_max(STR_DESTROYED_RES_TOTAL, n=10)

# Plot and label
f2 <- ggplot(data=ics.west, aes(x=START_YEAR, y=STR_DESTROYED_RES_TOTAL,
                                group=factor(INCIDENT_NAME), 
                                fill=STR_DESTROYED_RES_TOTAL), color="grey10") +
  geom_bar(stat="identity", position='stack') +
  scale_fill_viridis_c(option="plasma", trans="sqrt") +
  labs(x="Ignition Year\n", y="Homes Destroyed\n", fill="",
       title=
         "Homes destroyed by Western wildfires (1999-2020)\n",
       caption=
         "Maxwell C. Cook, PhD Student, Department of Geography\nData source: St. Denis et al., 2020 (updated)") +
  ggrepel::geom_text_repel(data=. %>% filter(INCIDENT_ID %in% top10$INCIDENT_ID), 
                           aes(label=INCIDENT_NAME), position=position_jitterdodge(0.5), size = 2) +
  theme_minimal() +
    # coord_cartesian(ylim=c(0, 1150)) +
  theme(plot.title = element_text(size = 12),
        plot.subtitle = element_text(size=8),
        plot.caption = element_text(size=7),
        axis.title.x = element_text(size=9),
        axis.title.y = element_text(size=9),
        axis.text.y = element_text(size=8),
        axis.text.x = element_text(size=8),
        legend.position="none")

f2

ggsave(f2, file = "../../figs/ICS209-PLUS_West_HomeLoss_byIncident.png",
       width=6, height=3.5, dpi = 300) # adjust dpi accordingly

rm(top10)

```

Plot cumulative residential structures destroyed from ICS-209-PLUS for CONUS and West.

```{r warning=F, message=F, fig.width=5, fig.height=3}

# Get some text
sum(ics.west$STR_DESTROYED_RES_TOTAL)
sum(ics.conus$STR_DESTROYED_RES_TOTAL)

## Group sum ics.west
ics.west.yr <- ics.west %>% 
  group_by(START_YEAR) %>%
  summarize(destr_res = sum(STR_DESTROYED_RES_TOTAL)) %>%
  mutate(destr_res_c = cumsum(destr_res))

# plot
f3 <- ics.conus %>% as_tibble() %>%
  group_by(START_YEAR) %>%
  summarize(destr_res = sum(STR_DESTROYED_RES_TOTAL)) %>%
  mutate(destr_res_c = cumsum(destr_res)) %>%
  ungroup() %>%
  ggplot() +
  geom_area(aes(x=START_YEAR, y=destr_res_c), position='stack', fill="grey60") +
  geom_line(data=ics.west.yr, aes(x=START_YEAR, y=destr_res_c, color="Western U.S."), position="stack",
            linetype = 4, size = 1.05) +
  scale_color_manual(name = "", values=c("Western U.S."="black")) +
  scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) + 
  labs(x="Ignition Year", y="Structures Destroyed",
       title="Cumulative homes destroyed by wildfire (1999-2020)\n")+
  # annotation_custom(grob) +
  theme_minimal() +
  theme(legend.position=c(0.2, 1.1))

f3

ggsave(f3, file = "../../figs/Cumulative_HomeLoss_West_and_CONUS.png",
       width=5, height=3, dpi = 300) # adjust dpi accordingly

```

Map of structures destroyed.

```{r fig.height=5, fig.width=5}

map1 <- ggplot() +
  geom_sf(data=ics.conus%>%filter(STR_DESTROYED_RES_TOTAL==0), color="gray60", size=0.3, alpha=0.9) +
  geom_sf(data=states, fill=NA, color="gray20") +
  geom_sf(data=ics.conus%>%filter(STR_DESTROYED_RES_TOTAL>0)%>%arrange(STR_DESTROYED_RES_TOTAL),
          aes(color=STR_DESTROYED_RES_TOTAL, size=FINAL_ACRES), alpha=0.8) +
  scale_size(range = c(1,6)) +
  scale_color_viridis_c(option="inferno", trans="log10") +
  labs(color = "Homes Destroyed") +
  coord_sf(crs = st_crs(ics.conus)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6, ticks=F,
                                 label.position = "right", title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),
         size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(0.85, 0.7))

map1

ggsave(map1, file = paste("../../figs/Map1-ICS209-PLUS_HomesDestroyed_Size_CONUS.png", sep=""), 
       width=5, height=5, dpi = 350) # adjust dpi accordingly

```

Plot cumulative structures destroyed from ICS-209-PLUS.

```{r warning=F, message=F, fig.width=5, fig.height=3}
# Create some text grob
# Text
grob <- grobTree(
   textGrob(paste("Total Destroyed Structures: ", as.integer(sum(ics$STR_DESTROYED_TOTAL)), sep=""), 
            x=0.05,  y=0.90, hjust=0, gp=gpar(col="grey20", fontsize=8, fontface="italic")),
   textGrob(paste("Destroyed Residential Structures: ", as.integer(sum(ics$STR_DESTROYED_RES_TOTAL)), sep=""), 
            x=0.05,  y=0.80, hjust=0, gp=gpar(col="grey20", fontsize=8, fontface="italic")),
   textGrob(paste("Number of 'Destructive' Incidents: ", dim(ics %>% filter(STR_DESTROYED_TOTAL>=1))[1], sep=""), 
            x=0.05,  y=0.70, hjust=0, gp=gpar(col="grey20", fontsize=8, fontface="italic")),
   textGrob(paste("Number of 'Destructive' Incidents (Res.): ", dim(ics %>% filter(STR_DESTROYED_RES_TOTAL>=1))[1], sep=""), 
            x=0.05,  y=0.60, hjust=0, gp=gpar(col="grey20", fontsize=8, fontface="italic")))
# plot
f1 <- ics %>% as_tibble() %>%
  group_by(START_YEAR) %>%
  summarize(destr_tot = sum(STR_DESTROYED_TOTAL),
            destr_res = sum(STR_DESTROYED_RES_TOTAL)) %>%
  mutate(destr_tot_c = cumsum(destr_tot),
         destr_res_c = cumsum(destr_res)) %>%
  ungroup() %>%
  ggplot() +
    geom_area(aes(x=START_YEAR, y=destr_tot_c), fill="#8c2d04") +
    geom_area(aes(x=START_YEAR, y=destr_res_c), position='identity', fill="#fee391") +
  scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) + 
  geom_bar(aes(x=START_YEAR, y=destr_tot), position='identity', stat='identity') +
  labs(x="Ignition Year", y="Structures Destroyed", fill="Legend")+
  annotation_custom(grob) +
  theme_minimal()
f1
ggsave(f1, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209/", "SuppFigure_StructureLoss.png", sep=""), 
       width=5, height=3, dpi = 700) # adjust dpi accordingly
```

## Changing human causes/consequences of fire


Bring in the modified table.

```{r include=F, warning=F}

# subset latest release to West
spatial.west <- spatial.conus %>% filter(STUSPS %in% west)

ics.west_ <- as.data.frame(
  readxl::read_excel("../../../earth-lab/projects/human-caused-fire-impacts/data/wf-incidents/ics209plus_wf_incidents_west_1999to2020_qc_PEH.xlsx"))

```

Compare the cause codes.

```{r}


```

Comparison with MTBS 1999-2020.

```{r}

# bring in mtbs

mtbs <- st_read("../../../data/mtbs/mtbs_perims_1984_2020/mtbs_perims_1984_2020_nad83.gpkg")

# subset western states

states.west <- st_read("../../../data/boundaries/political/TIGER/tl19_us_states_conus_nad83.gpkg")

# isolate to western U.S.

mtbs.west <- st_intersection(mtbs, states.west %>% dplyr::select(STUSPS), join=st_intersects, largest=T)

st_write(mtbs.west,
         "../../../data/mtbs/mtbs_perims_1984_2020/mtbs_perims_1984_2020_nad83_west.gpkg",
         delete_dsn=TRUE)

```

Compare ICS209-PLUS burned area to MTBS.

```{r}

mtbs.west_ <- mtbs.west %>%
  mutate(START_YEAR = lubridate::year(Ig_Date)) %>%
  filter(START_YEAR >= 1999) %>%
  group_by(START_YEAR) %>%
  summarize(burned_area = sum(BurnBndAc))

ics.west %>%
  group_by(START_YEAR) %>%
  summarize(burned_area = sum(FINAL_ACRES)) %>%
  ggplot( aes( x=START_YEAR, y=burned_area ) ) +
  geom_line( data=mtbs.west_, aes( x=START_YEAR, y=burned_area, color="Western U.S." ), 
             position="stack", linetype = 6, size = 0.8 ) +
  geom_point( data=mtbs.west_, aes( x=START_YEAR, y=burned_area ), 
              shape=21, size = 1.75, color = "gray20", fill = "gray50" ) +
  geom_line( ) +
  geom_point( shape=21, size = 2.5, color = "gray20", fill = "red" ) +
  scale_y_continuous( labels = scales::label_number(suffix = " M", scale = 1e-6) ) +
  scale_x_continuous( limits=c(1999, 2020) ) +
  scale_color_manual( name = "", values=c("Western U.S."="gray60") ) +
  labs( x="\nIgnition Year", y="Burned Area (acres)\n", 
        title="Conterminous U.S. burned area (1999-2020)\n" ) +
  theme_minimal( ) +
  theme( plot.title = element_text(size = 12, hjust=-0.4),
        legend.position=c(0.2, 1.1) )

```


```{r fig.width=5, fig.height=3}

# Group the western U.S. incidents
ics.west.yr <- ics.west %>% 
  group_by(START_YEAR) %>%
  summarize(burned_area = sum(FINAL_ACRES)) %>%
  ungroup()

# Grab the top 5
top5 <- ics.west.yr %>% slice_max(burned_area, n=5)

# Plot
f1 <- ics.conus %>% group_by(START_YEAR) %>%
  summarize(burned_area = sum(FINAL_ACRES)) %>%
  ungroup() %>%
  ggplot(aes(x=START_YEAR, y=burned_area)) +
  geom_line(data=ics.west.yr, aes(x=START_YEAR, y=burned_area, color="Western U.S."), position="stack",
            linetype = 6, size = 0.8) +
  geom_point(data=ics.west.yr, aes(x=START_YEAR, y=burned_area), 
             shape=21, size = 1.75, color = "gray20", fill = "gray50") +
  geom_text(data=. %>% filter(START_YEAR %in% top5$START_YEAR), 
            aes(label=paste(round(burned_area / 1e6, 1), "M")),
            position=position_nudge(x=-1.2,y=-10), size=3) +
  geom_line() +
  geom_point(shape=21, size = 2.5, color = "gray20", fill = "red") +
  scale_y_continuous(labels = scales::label_number(suffix = " M", scale = 1e-6)) +
  scale_x_continuous(limits=c(1999, 2020)) +
  scale_color_manual(name = "", values=c("Western U.S."="gray60")) +
  labs(x="\nIgnition Year", y="Burned Area (acres)\n", title="Conterminous U.S. burned area (1999-2020)\n") +
  theme_minimal() +
  theme(plot.title = element_text(size = 12, hjust=-0.4),
        legend.position=c(0.2, 1.1))

f1

ggsave(f1, file = "../../figs/ICS209-PLUS_BurnedArea_westANDconus.png",
       width=5, height=3, dpi = 300) # adjust dpi accordingly

rm(top5)

```

Plot destruction and area burned for the two decades (1999-2009, 2010-2020).

```{r fig.height=7, fig.width=4}

plasma_pal <- viridis::rocket(6)

breaks = c(1,10,100,1000,10000)

# 2001 to 2010

df <- ics.west %>% filter(START_YEAR <= 2009) %>%
  st_transform(st_crs(4326))

m1 <- ggplot() +
  geom_sf(data=df %>% filter(STR_DESTROYED_TOTAL==0), color="gray70", size=0.3, alpha=0.9) +
  geom_sf(data=states.west, fill=NA, color="gray10") +
  geom_sf(data=df %>% filter(STR_DESTROYED_TOTAL>0)%>%arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.75) +
  scale_size(range = c(1,6)) +
  # scale_color_viridis_c(option="plasma", trans="log10") +
  # scale_color_gradient(trans = "log", labels = breaks) +
  scale_color_gradientn(trans = "log10", breaks = breaks, labels = breaks, guide = "color",
                        colors = viridis_pal(begin=0.85, end=0.2, option="rocket")(3)) +
  labs(color = "Structures Destroyed",
       title="1999-2009") +
  coord_sf(crs = st_crs(4326)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6.5, ticks=F,
                                 title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),
         size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(1.1, 0.75))

## 2010-2020

df <- ics.west %>% filter(START_YEAR > 2009) %>%
  st_transform(st_crs(4326))

m2 <- ggplot() +
  geom_sf(data=df %>% filter(STR_DESTROYED_TOTAL==0), color="gray70", size=0.3, alpha=0.9) +
  geom_sf(data=states.west, fill=NA, color="gray10") +
  geom_sf(data=df %>% filter(STR_DESTROYED_TOTAL>0)%>%arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.75) +
  scale_size(range = c(1,6)) +
  # scale_color_viridis_c(option="plasma", trans="log10") +
  # scale_color_gradient(trans = "log", labels = breaks) +
  scale_color_gradientn(trans = "log10", breaks = breaks, labels = breaks, guide="color",
                        colors = viridis_pal(begin=0.85, end=0.2, option="rocket")(3)) +
  labs(color = "Structures Destroyed",
       title="2010-2020") +
  coord_sf(crs = st_crs(4326)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6.5, ticks=F,
                                 title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(1.1, 0.75))

########### Arrange
arr <- ggarrange(m1,m2, nrow=2, ncol=1, common.legend = TRUE, legend = "left")

arr

ggsave(arr, file = paste("../../ICS209-PLUS_Westwide_Decadal_HomeLoss_2panel.png", sep=""), 
       width=4, height=7, dpi = 500, bg="white") # adjust dpi accordingly

rm(df, arr)

```

4-panel plot by cause code. Version 1.

```{r  fig.height=7.25, fig.width=7.5}

# low = "#c6dbef", high="#084594" lightning
# low = "#fcbba1", high="#99000d" human

breaks = c(1,10,100,1000,10000)

states <- st_read("../../../data/boundaries/political/TIGER/tl19_us_states_conus.gpkg") %>%
        st_transform(crs=st_crs(spatial.conus))

########### 1999-2009, human caused

df1 <- spatial.west %>% 
  filter(START_YEAR <= 2009,
         CAUSE_UPDATED == "H") %>%
  st_transform(st_crs(4326))

m3 <- ggplot() +
  geom_sf(data=df1 %>% filter(STR_DESTROYED_TOTAL==0), aes(size=FINAL_ACRES), color="gray80", alpha=0.4) +
  scale_size(range = c(1,6)) +
  geom_sf(data=states%>%filter(STUSPS %in% west), fill=NA, color="gray10") +
  geom_sf(data=df1 %>% filter(STR_DESTROYED_TOTAL>0)%>%arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.9) +
  scale_size(range = c(1,6)) +
  # scale_color_viridis_c(option="plasma", trans="log10") +
  # scale_color_gradient(trans = "log", labels = breaks) +
  scale_color_gradient(trans = "log10", breaks = breaks, labels = breaks, guide="color",
                       low = "#fcbba1", high="#99000d") +
  labs(color = "Structures Destroyed",
       title="1999-2009 (Human-related)") +
  coord_sf(crs = st_crs(4326)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6.5, ticks=F,
                                 title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),
         size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(1.1, 0.75))



########### 1999 to 2009, lightning

df2 <- spatial.west %>% 
  filter(START_YEAR <= 2009,
         CAUSE_UPDATED == "L") %>%
  st_transform(st_crs(4326))

m4 <- ggplot() +
  geom_sf(data=df2 %>% filter(STR_DESTROYED_TOTAL==0), aes(size=FINAL_ACRES), color="gray80", alpha=0.4) +
  scale_size(range = c(1,6)) +
  geom_sf(data=states%>%filter(STUSPS %in% west), fill=NA, color="gray10") +
  geom_sf(data=df2 %>% filter(STR_DESTROYED_TOTAL>0)%>%arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.9) +
  scale_size(range = c(1,6)) +
  # scale_color_viridis_c(option="plasma", trans="log10") +
  # scale_color_gradient(trans = "log", labels = breaks) +
  # scale_color_gradientn(trans = "log10", breaks = breaks, labels = breaks, guide="color",
  #                       colors = viridis_pal(begin=0.85, end=0.2, option="rocket")(3)) +
  scale_color_gradient(trans = "log10", breaks = breaks, labels = breaks, guide="color",
                       low = "#c6dbef", high="#084594", 
                       limits=c(min(df1$STR_DESTROYED_TOTAL)+1, max(df1$STR_DESTROYED_TOTAL))) +
  labs(color = "Structures Destroyed",
       title="1999-2009 (Lightning)") +
  coord_sf(crs = st_crs(4326)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6.5, ticks=F,
                                 title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(1.1, 0.75))




########### 2010-2020, human

df1 <- spatial.west %>% 
  filter(START_YEAR > 2009,
         CAUSE_UPDATED == "H") %>%
  st_transform(st_crs(4326))

m5 <- ggplot() +
  geom_sf(data=df1 %>% filter(STR_DESTROYED_TOTAL==0), aes(size=FINAL_ACRES), color="gray80", alpha=0.4) +
  scale_size(range = c(1,6)) +
  geom_sf(data=states%>%filter(STUSPS %in% west), fill=NA, color="gray10") +
  geom_sf(data=df1 %>% filter(STR_DESTROYED_TOTAL>0)%>%arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.9) +
  scale_size(range = c(1,6)) +
  # scale_color_viridis_c(option="plasma", trans="log10") +
  # scale_color_gradient(trans = "log", labels = breaks) +
  scale_color_gradient(trans = "log10", breaks = breaks, labels = breaks, guide="color",
                       low = "#fcbba1", high="#99000d") +
  labs(color = "Structures Destroyed",
       title="2010-2020 (Human-related)") +
  coord_sf(crs = st_crs(4326)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6.5, ticks=F,
                                 title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(1.1, 0.75))




########### 2010-2020, lightning

df2 <- spatial.west %>% 
  filter(START_YEAR > 2009,
         CAUSE_UPDATED == "L") %>%
  st_transform(st_crs(4326))

m6 <- ggplot() +
  geom_sf(data=df2 %>% filter(STR_DESTROYED_TOTAL==0), aes(size=FINAL_ACRES), color="gray80", alpha=0.4) +
  scale_size(range = c(1,6)) +
  geom_sf(data=states%>%filter(STUSPS %in% west), fill=NA, color="gray10") +
  geom_sf(data=df2 %>% filter(STR_DESTROYED_TOTAL>0)%>%arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.9) +
  scale_size(range = c(1,6)) +
  # scale_color_viridis_c(option="plasma", trans="log10") +
  # scale_color_gradient(trans = "log", labels = breaks) +
  # scale_color_gradientn(trans = "log10", breaks = breaks, labels = breaks, guide="color",
  #                       colors = viridis_pal(begin=0.85, end=0.2, option="rocket")(3)) +
  scale_color_gradient(trans = "log10", breaks = breaks, labels = breaks, guide="color",
                       low = "#c6dbef", high="#084594", 
                       limits=c(min(df1$STR_DESTROYED_TOTAL)+1, max(df1$STR_DESTROYED_TOTAL))) +
  labs(color = "Structures Destroyed",
       title="2010-2020 (Lightning)") +
  coord_sf(crs = st_crs(4326)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6.5, ticks=F,
                                 title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8))) +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(1.1, 0.75))


########### Arrange
arr <- ggarrange(ggarrange(m3,m5,common.legend=TRUE,legend="left")+theme(plot.margin=margin(0.1,0.1,1.25,0.1)), 
                 ggarrange(m4,m6,common.legend=TRUE,legend="left")+theme(plot.margin=margin(1.25,0.1,0.1,0.1)), 
                 nrow=2, ncol=1) +
  theme(plot.margin = margin(1,0.1,1,0.1, "cm")) 

arr

ggsave(arr, file = paste("../../ICS209-PLUS_Westwide_Decadal_HomeLoss_4panel.png", sep=""), 
       width=7.5, height=7, dpi = 500, bg="white") # adjust dpi accordingly

rm(df1, df2, arr)

```

4-panel plot by cause code. Version 2.

```{r  fig.height=7.25, fig.width=7.5}

# low = "#c6dbef", high="#084594" lightning
# low = "#fcbba1", high="#99000d" human

breaks = c(1,10,100,1000,10000)

states <- st_read("../../../data/boundaries/political/TIGER/tl19_us_states_conus.gpkg") %>%
        st_transform(crs=st_crs(spatial.conus))

########### 1999-2009, human caused

df1 <- spatial.west %>% 
  filter(START_YEAR <= 2009,
         CAUSE_UPDATED == "H") %>%
  st_transform(st_crs(4326))

m3 <- ggplot() +
  geom_sf(data=df1 %>% filter(STR_DESTROYED_TOTAL==0), aes(size=FINAL_ACRES), color="gray80", alpha=0.4) +
  scale_size(range = c(1,6)) +
  geom_sf(data=states%>%filter(STUSPS %in% west), fill=NA, color="gray10") +
  geom_sf(data=df1 %>% filter(STR_DESTROYED_TOTAL>0)%>%arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.9) +
  scale_size(range = c(1,6)) +
  # scale_color_viridis_c(option="plasma", trans="log10") +
  # scale_color_gradient(trans = "log", labels = breaks) +
  scale_color_gradient(trans = "log10", breaks = breaks, labels = breaks, guide="color",
                       low = "#fcbba1", high="#99000d") +
  labs(color = "Structures Destroyed",
       title="1999-2009 (Human-related)") +
  coord_sf(crs = st_crs(4326)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6.5, ticks=F,
                                 title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),
         size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(1.1, 0.75))



########### 1999 to 2009, lightning

df2 <- spatial.west %>% 
  filter(START_YEAR <= 2009,
         CAUSE_UPDATED == "L") %>%
  st_transform(st_crs(4326))

m4 <- ggplot() +
  geom_sf(data=df2 %>% filter(STR_DESTROYED_TOTAL==0), aes(size=FINAL_ACRES), color="gray80", alpha=0.4) +
  scale_size(range = c(1,6)) +
  geom_sf(data=states%>%filter(STUSPS %in% west), fill=NA, color="gray10") +
  geom_sf(data=df2 %>% filter(STR_DESTROYED_TOTAL>0)%>%arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.9) +
  scale_size(range = c(1,6)) +
  # scale_color_viridis_c(option="plasma", trans="log10") +
  # scale_color_gradient(trans = "log", labels = breaks) +
  # scale_color_gradientn(trans = "log10", breaks = breaks, labels = breaks, guide="color",
  #                       colors = viridis_pal(begin=0.85, end=0.2, option="rocket")(3)) +
  scale_color_gradient(trans = "log10", breaks = breaks, labels = breaks, guide="color",
                       low = "#c6dbef", high="#084594", 
                       limits=c(min(df1$STR_DESTROYED_TOTAL)+1, max(df1$STR_DESTROYED_TOTAL))) +
  labs(color = "Structures Destroyed",
       title="1999-2009 (Lightning)") +
  coord_sf(crs = st_crs(4326)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6.5, ticks=F,
                                 title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(1.1, 0.75))




########### 2010-2020, human

df1 <- spatial.west %>% 
  filter(START_YEAR > 2009,
         CAUSE_UPDATED == "H") %>%
  st_transform(st_crs(4326))

m5 <- ggplot() +
  geom_sf(data=df1 %>% filter(STR_DESTROYED_TOTAL==0), aes(size=FINAL_ACRES), color="gray80", alpha=0.4) +
  scale_size(range = c(1,6)) +
  geom_sf(data=states%>%filter(STUSPS %in% west), fill=NA, color="gray10") +
  geom_sf(data=df1 %>% filter(STR_DESTROYED_TOTAL>0)%>%arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.9) +
  scale_size(range = c(1,6)) +
  # scale_color_viridis_c(option="plasma", trans="log10") +
  # scale_color_gradient(trans = "log", labels = breaks) +
  scale_color_gradient(trans = "log10", breaks = breaks, labels = breaks, guide="color",
                       low = "#fcbba1", high="#99000d") +
  labs(color = "Structures Destroyed",
       title="2010-2020 (Human-related)") +
  coord_sf(crs = st_crs(4326)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6.5, ticks=F,
                                 title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8)),size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(1.1, 0.75))




########### 2010-2020, lightning

df2 <- spatial.west %>% 
  filter(START_YEAR > 2009,
         CAUSE_UPDATED == "L") %>%
  st_transform(st_crs(4326))

m6 <- ggplot() +
  geom_sf(data=df2 %>% filter(STR_DESTROYED_TOTAL==0), aes(size=FINAL_ACRES), color="gray80", alpha=0.4) +
  scale_size(range = c(1,6)) +
  geom_sf(data=states%>%filter(STUSPS %in% west), fill=NA, color="gray10") +
  geom_sf(data=df2 %>% filter(STR_DESTROYED_TOTAL>0)%>%arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=FINAL_ACRES), alpha=0.9) +
  scale_size(range = c(1,6)) +
  # scale_color_viridis_c(option="plasma", trans="log10") +
  # scale_color_gradient(trans = "log", labels = breaks) +
  # scale_color_gradientn(trans = "log10", breaks = breaks, labels = breaks, guide="color",
  #                       colors = viridis_pal(begin=0.85, end=0.2, option="rocket")(3)) +
  scale_color_gradient(trans = "log10", breaks = breaks, labels = breaks, guide="color",
                       low = "#c6dbef", high="#084594", 
                       limits=c(min(df1$STR_DESTROYED_TOTAL)+1, max(df1$STR_DESTROYED_TOTAL))) +
  labs(color = "Structures Destroyed",
       title="2010-2020 (Lightning)") +
  coord_sf(crs = st_crs(4326)) +
  theme_void() +
  guides(color = guide_colourbar(position="top", barwidth = 0.4, barheight = 6.5, ticks=F,
                                 title.position = "left",
                                 label.theme = element_text(angle = 0, size = 8))) +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(1.1, 0.75))


########### Arrange
arr <- ggarrange(ggarrange(m3,m5,common.legend=TRUE,legend="left")+theme(plot.margin=margin(0.1,0.1,1.25,0.1)), 
                 ggarrange(m4,m6,common.legend=TRUE,legend="left")+theme(plot.margin=margin(1.25,0.1,0.1,0.1)), 
                 nrow=2, ncol=1) +
  theme(plot.margin = margin(1,0.1,1,0.1, "cm")) 

arr

ggsave(arr, file = paste("../../ICS209-PLUS_Westwide_Decadal_HomeLoss_4panel_v2.png", sep=""), 
       width=7.5, height=7, dpi = 500, bg="white") # adjust dpi accordingly

rm(df1, df2, arr)

```


## ICS+FIRED 
## Colorado-specific plots

```{r}
ics.co <- ics.west %>% filter(STUSPS == 'CO')
paste("Number of wildfire incidents in 209s: ", dim(ics.co)[1])
paste("Number of destructive (n>1) CO incidents: ", dim(ics.co%>%filter(STR_DESTROYED_RES_TOTAL>0))[1])
paste("Total number of structures lost: ", sum(ics.co$STR_DESTROYED_TOTAL)+991)
paste("Total number of res. structures lost: ", sum(ics.co$STR_DESTROYED_RES_TOTAL)+1084)
tmp <- ics.co %>% filter(START_YEAR <= 2010)
paste("Res. structures lost 1999-2010: ", sum(tmp$STR_DESTROYED_RES_TOTAL))
tmp <- ics.co %>% filter(START_YEAR > 2010)
paste("Res. structures lost 2011-2021: ", sum(tmp$STR_DESTROYED_RES_TOTAL)+1084)
# Marshall Fire
paste("Marshall Fire % Destruction: ", 1091/sum(ics.co$STR_DESTROYED_TOTAL)*100)
paste("Marshall Fire % Destruction (residential): ", 1084/sum(ics.co$STR_DESTROYED_RES_TOTAL)*100)
```

Plot CO destruction.

```{r warning=F, message=F, fig.width=5.25, fig.height=3}
# plot
f2 <- ics.co %>% as_tibble() %>%
  group_by(START_YEAR) %>%
  summarize(destr_tot = sum(STR_DESTROYED_TOTAL),
            destr_res = sum(STR_DESTROYED_RES_TOTAL)) %>%
  mutate(destr_tot_c = cumsum(destr_tot),
         destr_res_c = cumsum(destr_res)) %>%
  ungroup() %>%
  add_row(START_YEAR = 2021, destr_tot = 1091, destr_res = 1084, destr_tot_c = 5357, destr_res_c = 3734) %>%
  ggplot() +
    geom_area(aes(x=START_YEAR, y=destr_tot_c, fill="Total Structures (Cumulative)")) +
    geom_area(aes(x=START_YEAR, y=destr_res_c, fill="Residential Structures (Cumulative)"), position='identity') +
    # scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
    geom_bar(aes(x=START_YEAR, y=destr_tot, fill="Annual Loss (Total)"), stat='identity') +
    scale_fill_manual(values = c("grey15", "#8c2d04", "#fee391"), guide = guide_legend(reverse = TRUE)) +
    # geom_bar(aes(x=START_YEAR, y=destr_res, fill="Res. Structures"), position='identity', stat='identity') +
    labs(x="\nIgnition Year", y="Structures Destroyed\n", fill="",
         title="Colorado Wildfire-Related Structure Loss (1999-2021)\n") +
    theme_minimal() +
    theme(plot.title = element_text(size = 12), legend.position=c(0.35, 0.8))
f2
ggsave(f2, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209/figs/", "CO_StructureLoss.png", sep=""), 
       width=5, height=3, dpi = 700) # adjust dpi accordingly
```

Plot CO destruction. Not cumulative.

```{r warning=F, message=F, fig.width=5.25, fig.height=3}
# plot
f3 <- ics.co %>% as_tibble() %>%
  group_by(START_YEAR) %>%
  summarize(destr_tot = sum(STR_DESTROYED_TOTAL),
            destr_res = sum(STR_DESTROYED_RES_TOTAL)) %>%
  ungroup() %>%
  add_row(START_YEAR = 2021, destr_tot = 1091, destr_res = 1084) %>%
  ggplot() +
    geom_bar(aes(x=START_YEAR, y=destr_res), fill="#a63603", stat="identity", position='identity') +
    labs(x="\nIgnition Year", y="Homes Destroyed\n", fill="",
         title="Colorado Wildfire-Related Home Loss (1999-2021)\n") +
    theme_minimal() +
    theme(plot.title = element_text(size = 12), legend.position="top")
f3
ggsave(f3, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209/figs/", "CO_StructureLoss_NoCSum_RES.png", sep=""), 
       width=5, height=3, dpi = 700) # adjust dpi accordingly
```

Plot CO destruction. Not cumulative. By incident.

```{r warning=F, message=F, fig.width=5.5, fig.height=3.5}
plasma_pal <- viridis::plasma(6)
# plot
f4 <- ics.co %>% as_tibble() %>%
  add_row(INCIDENT_NAME = "MARSHALL FIRE", START_YEAR = 2021, STR_DESTROYED_TOTAL = 1091, STR_DESTROYED_RES_TOTAL = 1084) %>%
  ggplot(aes(x=START_YEAR, y=STR_DESTROYED_RES_TOTAL, group=factor(INCIDENT_NAME), fill=STR_DESTROYED_RES_TOTAL), color="grey10") +
    geom_bar(stat="identity", position='stack') +
    scale_fill_gradientn(colors = viridis_pal(begin=0, end=0.9, option="plasma")(3)) +
    labs(x="Ignition Year\n", y="Homes Destroyed\n", fill="",
         title="Homes destroyed by Colorado wildfires (1999-2021)\n",
         caption="Maxwell C. Cook, PhD Student, Department of Geography,\nDr. Jennifer K. Balch, Director, Earth Lab\nData source: St. Denis et al., 2020 (updated)") +
    theme_minimal() +
    coord_cartesian(ylim=c(0, 1150)) +
    theme(plot.title = element_text(size = 11.5, hjust = -0.55),
          plot.subtitle = element_text(size=8),
          plot.caption = element_text(size=7),
          axis.title.x = element_text(size=9),
          axis.title.y = element_text(size=9),
          axis.text.y = element_text(size=8),
          axis.text.x = element_text(size=8),
          legend.position="none")
f4
ggsave(f4, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209/figs/", "CO_StructureLoss_NoCSum_RES_byIncident.png", sep=""), 
       width=5.5, height=3.5, dpi = 700) # adjust dpi accordingly
```

Show top 15 most destructive fires in western U.S.

```{r}
ics.top <- top_n(ics, 15, STR_DESTROYED_RES_TOTAL)
```

```{r warning=F, message=F, fig.width=5.25, fig.height=3}
# plot
f4 <- ics.co %>% as_tibble() %>%
  group_by(START_YEAR) %>%
  summarize(destr_tot = sum(STR_DESTROYED_TOTAL),
            destr_res = sum(STR_DESTROYED_RES_TOTAL)) %>%
  mutate(destr_tot_c = cumsum(destr_tot),
         destr_res_c = cumsum(destr_res)) %>%
  ungroup() %>%
  add_row(START_YEAR = 2021, destr_tot = 991, destr_res = 969, destr_tot_c = 5357, destr_res_c = 3734) %>%
  ggplot() +
    geom_area(aes(x=START_YEAR, y=destr_res_c, fill="Residential Structures (Cumulative)"), position='identity') +
    # scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
    geom_bar(aes(x=START_YEAR, y=destr_res, fill="Annual Loss (Total)"), stat='identity') +
    scale_fill_manual(values = c("grey15", "#a63603"), guide = guide_legend(reverse = TRUE)) +
    # geom_bar(aes(x=START_YEAR, y=destr_res, fill="Res. Structures"), position='identity', stat='identity') +
    labs(x="\nIgnition Year", y="Homes Destroyed\n", fill="",
         title="Colorado Wildfire-Related Home Loss (1999-2021)\n") +
    theme_minimal() +
    theme(plot.title = element_text(size = 12), legend.position=c(0.35, 0.8))
f4
ggsave(f4, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209/figs/", "CO_StructureLoss_RES.png", sep=""), 
       width=5, height=3, dpi = 700) # adjust dpi accordingly
```

Timing of destruction based on ignition date.

```{r}
ics.co %>%
  filter(STR_DESTROYED_RES_TOTAL>0) %>%
  group_by(START_MONTH) %>%
  summarize(n = n()) %>%
  glimpse()
print("____________________________")
ics.co %>%
  group_by(START_MONTH) %>%
  summarize(n = n()) %>%
  glimpse()
```

```{r}
tmp <- ics.co %>% group_by(START_YEAR) %>%
  mutate(FINAL_HA = FINAL_ACRES*0.404686) %>%
  summarize(burned_area = sum(FINAL_ACRES),
            str_des = sum(STR_DESTROYED_RES_TOTAL)) %>%
  ungroup() %>%
  add_row(START_YEAR = 2021, burned_area = 132.97, str_des = 991) %>%
  mutate(rate = str_des / burned_area)
glimpse(tmp)
```

Homes per acres burned area by year. 2021 = ~32,860 acres (132.97)

```{r warning=F, message=F, fig.width=5.25, fig.height=3}
f3 <- ics.co %>% group_by(START_YEAR) %>%
  mutate(FINAL_HA = FINAL_ACRES*0.404686) %>%
  summarize(burned_area = sum(FINAL_KM2),
            str_des = sum(STR_DESTROYED_RES_TOTAL)) %>%
  ungroup() %>%
  add_row(START_YEAR = 2021, burned_area = 132.97, str_des = 991) %>%
  mutate(rate = str_des / burned_area) %>%
  ggplot() +
  geom_bar(aes(x=START_YEAR, y=rate), stat="identity") +
  geom_line(aes(x=START_YEAR, y=log(burned_area), color="log(Burned Area) (KM2)")) +
  labs(x="\nIgnition Year", y="Structures per Km2 Burned\n", color="",
         title="Colorado Wildfire-Related Structure Loss Rate (1999-2021)\n") +
  theme_minimal() +
  theme(plot.title = element_text(size = 11), legend.position=c(0.2, 1.1))
f3
ggsave(f3, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209/figs/", "CO_StructureLoss_Rate.png", sep=""), 
       width=5, height=3, dpi = 700) # adjust dpi accordingly
```

MTBS record burned area (and burned area December).

```{r}
co <- st_read("C:/Users/mccoo/OneDrive/mcook/data/boundaries/political/colorado.gpkg", quiet=T) %>%
  st_transform(st_crs(mtbs))
glimpse(mtbs)
mtbs.co <- mtbs %>% st_intersection(., co) %>% mutate(MTBS_YEAR = as.integer(MTBS_YEAR))
```

```{r}
ics.co.20 <- ics.co %>% filter(START_YEAR == 2020)
sum(ics.co.20$FINAL_ACRES)
```

```{r warning=F, message=F, fig.width=5.25, fig.height=3}
f6 <- mtbs.co %>% group_by(MTBS_YEAR) %>%
  summarize(burned_area = sum(MTBS_ACRES)) %>%
  ungroup() %>%
  add_row(MTBS_YEAR=2020, burned_area=678721.3) %>%
  add_row(MTBS_YEAR=2021, burned_area=32860) %>%
  ggplot(aes(x=MTBS_YEAR, y=burned_area)) +
  geom_line() +
  geom_point(shape=21, size = 3, color = "gray30", fill = "red") +
  scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
  scale_x_continuous(limits=c(1984, 2021)) +
  labs(x="\nIgnition Year", y="Burned Area (acres)\n", title="Colorado Burned Area (1984-2021)\n") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14))
f6
ggsave(f6, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209/figs/", "CO_BurnedArea_1984to2021.png", sep=""), 
       width=5, height=3, dpi = 700) # adjust dpi accordingly
```

```{r warning=F, message=F, fig.width=5.25, fig.height=3}
dec <- ics.co %>% filter(START_MONTH=="Dec")
f9 <- mtbs.co %>% group_by(MTBS_YEAR) %>%
  summarize(burned_area = sum(MTBS_ACRES)) %>%
  ungroup() %>%
  add_row(MTBS_YEAR=2020, burned_area=678721.3) %>%
  add_row(MTBS_YEAR=2021, burned_area=32860) %>%
  ggplot(aes(x=MTBS_YEAR, y=log(burned_area))) +
  geom_line() +
  geom_point(shape=21, size = 3, color = "gray30", fill = "red") +
  scale_y_continuous(labels = scales::label_number(suffix = " K", scale = 1e-3)) +
  scale_x_continuous(limits=c(1984, 2021)) +
  labs(x="\nIgnition Year", y="Burned Area (acres)\n", title="Colorado Burned Area (1984-2021)\n") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14))
f9
ggsave(f6, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209/figs/", "CO_BurnedArea_1984to2021.png", sep=""), 
       width=5, height=3, dpi = 700) # adjust dpi accordingly
```

Add structure loss.

```{r}
tmp1 <- mtbs.co %>% group_by(MTBS_YEAR) %>%
  summarize(burned_area = sum(MTBS_ACRES)) %>%
  ungroup() %>%
  add_row(MTBS_YEAR=2020, burned_area=678721.3) %>%
  add_row(MTBS_YEAR=2021, burned_area=32860) %>%
  rename(START_YEAR = MTBS_YEAR)
tmp2 <- ics.co %>% as_tibble() %>%
  group_by(START_YEAR) %>%
  summarize(destr_tot = sum(STR_DESTROYED_TOTAL),
            destr_res = sum(STR_DESTROYED_RES_TOTAL)) %>%
  ungroup() %>%
  add_row(START_YEAR = 2021, destr_tot = 991, destr_res = 969)
```


```{r warning=F, message=F, fig.width=5.25, fig.height=3}
f7 <- tmp1 %>%
  mutate(burned_km2 = burned_area*0.00404686) %>%
  ggplot(aes(x=START_YEAR, y=log(burned_area))) +
  geom_line() +
  geom_point(shape=21, size = 3, color = "gray30", fill = "red") +
  scale_x_continuous(limits=c(1984, 2021)) +
  geom_bar(data=tmp2, aes(x=START_YEAR, y=destr_res), stat="identity") +
  labs(x="\nIgnition Year", y="Burned Area (acres)\n", title="Colorado Burned Area (1984-2021)\n") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14))
f7
ggsave(f7, file = paste("C:/Users/mccoo/OneDrive/mcook/ics209/figs/", "CO_BurnedArea_1984to2021_wRES.png", sep=""), 
       width=5, height=3, dpi = 700) # adjust dpi accordingly
```


# Supp. Hexbin summaries maps

```{r warning=F}

conus <- ggplot() +
  geom_sf(data=states, fill=NA, color="gray20") +
  geom_sf(data=ics.points %>%
           arrange(STR_DESTROYED_TOTAL),
          aes(color=STR_DESTROYED_TOTAL, size=STR_DESTROYED_TOTAL), alpha=0.8) +
  scale_size(range = c(1,6)) +
  scale_color_viridis_c(option="inferno", trans="log10") +
  labs(color = "Destroyed Structures") +
  coord_sf(crs = st_crs(ics.points)) +
  theme_void() +
  guides(color = guide_colourbar(
     position="top", barwidth = 0.4, barheight = 6, ticks=F,
     label.position = "right", title.position = "left",
     label.theme = element_text(angle = 0, size = 8)),
     size="none") +
  theme(legend.title = element_text(angle = 90, size=10),
        legend.position=c(0.85, 0.7))

conus

# ggsave(map1, file = paste("../../figs/Map1-ICS209-PLUS_HomesDestroyed_Size_CONUS.png", sep=""), 
#        width=5, height=5, dpi = 350) # adjust dpi accordingly

```

Hexbin map(s).

```{r}

# create the hex grid
hex <- st_make_grid(
   states, n=c(50,50), what="polygons", square=FALSE, 
   flat_topped=TRUE, crs=st_crs(lambert.prj)) %>%
   st_as_sf() %>%
   mutate(HEXID = floor(as.numeric(rownames(.))))

# Join to incident reports
hex.join <- st_join(ics.points, hex %>% st_transform(st_crs(lambert.prj)), join=st_within)

# Create the summary table
sums <- hex.join %>% group_by(HEXID) %>%
   st_drop_geometry() %>%
   summarize(counts = n()) %>%
   ungroup()

# Join back to hex grid
hex_ <- inner_join(hex %>% as_tibble(), sums, by="HEXID") %>% st_as_sf()

# plot it
hexmap <- ggplot()+
   geom_sf(data=states, color="transparent", fill="gray90", size=0.5)+
   geom_sf(data=hex_, aes(fill=counts), color="transparent")+
   scale_fill_viridis_c(option="inferno", trans="log10", alpha=0.9)+
   geom_sf(data=states, color="gray30", fill="transparent", size=0.5)+
   theme_void() +
   guides(
          fill = guide_colourbar(
             position="top", barwidth = 0.4, barheight = 6, ticks=F,
             label.position = "right", title.position = "left",
             label.theme = element_text(angle = 0, size = 8))) +
   labs(fill="log(Fire Counts)") +
   theme(legend.title = element_text(angle = 90, size=10),
         legend.position=c(0.9, 0.3))

hexmap

# # Save
# ggsave(hexmap, file = "../../figures/ics209plus_fired_FireCounts_Hex_CONUS.png",
#        width=5, height=3.5, dpi = 500, bg="white") # adjust dpi accordingly

```

Alaska only.

```{r}

ak <- states %>% filter(STUSPS=="AK")

# create the hex grid
hex <- st_make_grid(
   ak, n=c(25,25), what="polygons", square=FALSE, 
   flat_topped=TRUE, crs=st_crs(lambert.prj)) %>%
   st_as_sf() %>%
   mutate(HEXID = floor(as.numeric(rownames(.))))

# Join to incident reports
hex.join <- st_join(ics.points %>% filter(STUSPS == 'AK'), 
                    hex %>% st_transform(st_crs(lambert.prj)), 
                    join=st_within)

# Create the summary table
sums <- hex.join %>% group_by(HEXID) %>%
   st_drop_geometry() %>%
   summarize(counts = n()) %>%
   ungroup()

# Join back to hex grid
hex_ <- inner_join(hex %>% as_tibble(), sums, by="HEXID") %>% st_as_sf()

# plot it
ggplot()+
   geom_sf(data=hex_, aes(fill=counts), color="transparent")+
   scale_fill_viridis_c(option="inferno", trans="log10", alpha=0.9)+
   geom_sf(data=ak, color="gray50", fill="transparent", size=0.5)+
   theme_void() +
   guides(fill="none")

```

Histogram.

```{r fig.height=2, fig.width=3.5}

incidents %>% group_by(START_YEAR) %>%
   summarize(
      counts = n()) %>%
   ggplot(aes(x=START_YEAR, y=counts)) +
   geom_bar(stat="identity")

```
```{r}



```

